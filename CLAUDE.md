# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Minority Rule Game** - A blockchain-based game where players vote YES/NO on questions, and only those in the minority advance. Built with Foundry (Solidity), Ponder (indexer), and Next.js (frontend).

Repository structure:
- `solidity/` - Smart contracts (Foundry)
- `indexer/` - Event indexer with GraphQL API (Ponder)
- `websocket/` - WebSocket server for real-time updates
- `frontend/` - Web interface (Next.js + React)

## Common Development Commands

### Solidity (Contract Development)
```bash
cd solidity

# Build contracts
forge build

# Run tests with verbose output
forge test -vv

# Deploy to local Anvil
forge script script/Deploy.s.sol --broadcast --rpc-url http://localhost:8545

# Deploy to Base Sepolia
source .env
forge script script/Deploy.s.sol:DeployScript --rpc-url base_sepolia --broadcast --verify

# Extract ABI for indexer (after building)
cd ../indexer
npm run extract-abi
```

### Indexer (Ponder)
```bash
cd indexer

# Start development server with fresh database
npm run dev:fresh

# Start without resetting database
npm run dev

# Reset Ponder database and cached data
npm run reset

# Extract ABI from compiled contract
npm run extract-abi

# Ponder GraphQL endpoint (when running)
# http://localhost:42069/graphql
```

### WebSocket Server (Real-Time Updates)
```bash
cd websocket

# Start development server
npm run dev

# Build for production
npm run build

# Run production build
npm start

# WebSocket server runs on http://localhost:3001
# Health check: http://localhost:3001/health
```

### Frontend (Next.js)
```bash
cd frontend

# Start development server
npm run dev

# Build for production
npm run build

# Generate GraphQL types from Ponder schema
npm run codegen

# Watch mode for GraphQL codegen
npm run codegen:watch

# Lint code
npm run lint
```

### Local Development Workflow
1. Start Anvil: `cd solidity && anvil`
2. Deploy contract: `forge script script/Deploy.s.sol --broadcast --rpc-url http://localhost:8545`
3. Copy contract address and update `indexer/.env` (CONTRACT_ADDRESS_ANVIL) and `frontend/.env.local` (NEXT_PUBLIC_CONTRACT_ADDRESS_ANVIL)
4. Start indexer: `cd indexer && npm run dev:fresh`
5. Start WebSocket server: `cd websocket && npm run dev`
6. Start frontend: `cd frontend && npm run dev`

**Note**: The WebSocket server is optional. If not running, the frontend will fall back to polling for updates.

## Architecture

### Three-Tier Architecture

**Layer 1: Smart Contract (Solidity)**
- `MinorityRuleGame.sol` - Core game logic with commit-reveal voting
- Events: GameCreated, PlayerJoined, VoteCommitted, VoteRevealed, RoundCompleted, GameCompleted
- Game flow: ZeroPhase → CommitPhase → RevealPhase → (process round) → repeat or Completed
- Manual deadline control: Creator sets commit/reveal deadlines for each round

**Layer 2: Indexer (Ponder)**
- Location: `indexer/src/index.ts`
- Listens to contract events and populates Postgres database
- Schema: `indexer/ponder.schema.ts` - games, players, votes, commits, rounds, winners, eliminations
- GraphQL API auto-generated by Ponder at port 42069
- Database tables use onchain tables (optimized for blockchain data)
- Sends fire-and-forget HTTP notifications to WebSocket server after each event

**Layer 2.5: WebSocket Server (Real-Time)**
- Location: `websocket/src/`
- Receives HTTP notifications from Ponder (fire-and-forget, 2s timeout)
- Broadcasts events to subscribed frontend clients via WebSocket
- Room-based subscriptions: `game:1`, `list:active`, etc.
- Runs on port 3001, independent from Ponder
- Optional - frontend falls back to polling if not running

**Layer 3: Frontend (Next.js)**
- Data fetching: Migrated to Ponder GraphQL (from direct Supabase queries)
- GraphQL queries: `frontend/src/lib/graphql/queries.ts`
- Client: urql with WebSocket support for subscriptions
- State management: React Query with adaptive polling based on game state
- Blockchain interaction: Wagmi v2 + Viem
- Real-time updates: WebSocket client with auto-reconnection

### Data Flow

**Real-time flow (with WebSocket server):**
```
Blockchain Event → Ponder Indexer → Postgres → GraphQL API
                       ↓                              ↓
                  WebSocket Server             Frontend (GraphQL queries)
                       ↓                              ↓
                  Frontend (WS events) ────→ React Query (cache invalidation)
                                                       ↓
User Action → Wagmi (writeContract) → Transaction → Wait for Receipt → Invalidate Cache
```

**Fallback flow (without WebSocket server):**
```
Blockchain Event → Ponder Indexer → Postgres → GraphQL API → Frontend (urql + React Query + Polling)
                                                            ↓
User Action → Wagmi (writeContract) → Transaction → Wait for Receipt → Invalidate Cache
```

**Key points:**
- WebSocket notifications trigger instant cache invalidation (no polling delay)
- Ponder never blocks on WebSocket calls (fire-and-forget with 2s timeout)
- Frontend continues working if WebSocket server is down (adaptive polling fallback)
- All data still fetched via GraphQL - WebSocket only triggers cache invalidation

### Current Migration Status

The project is in the middle of a **Ponder GraphQL migration**:

**Completed:**
- GraphQL client infrastructure (`frontend/src/lib/graphql/`)
- All GraphQL queries written (`queries.ts`, `subscriptions.ts`)
- Frontend hooks updated to use GraphQL (`use-games.ts`)
- Pagination implemented (limit/offset for GraphQL, legacy Supabase also has pagination)

**Known Issue:**
- Ponder GraphQL server not consistently starting on port 42069
- See `QUICK_START_GUIDE.md` and `GRAPHQL_MIGRATION_STATUS.md` for troubleshooting

**Fallback:**
- Supabase queries still available in `frontend/src/lib/supabase.ts`
- Can revert to Supabase if Ponder GraphQL issues persist (still has pagination benefits)

## Key Technical Patterns

### 1. Commit-Reveal Voting
Players cannot see votes until reveal phase to prevent front-running:
- Commit: `keccak256(abi.encodePacked(vote, salt))`
- Salt stored in localStorage: `vote-salt-${gameId}-${round}`
- Reveal: Submit original vote + salt, contract verifies hash matches

### 2. BigInt Handling
All wei values (entry_fee, prize_pool, etc.) stored as strings in database:
- Contract emits: `uint256` (BigInt in JS)
- Indexer stores: `.toString()`
- Frontend converts: `BigInt(value)` when needed
- Display: `formatEther()` from viem

### 3. Address Normalization
All addresses stored lowercase for consistency:
- Indexer: `event.args.player.toLowerCase()`
- Frontend queries: Always use lowercase addresses
- Display: `formatAddress(address)` utility for "0x1234...5678"

### 4. Adaptive Polling Strategy
Frontend uses hierarchical polling to minimize network requests:
- **Primary query** (`useGame`): Polls based on game state
  - Active phases (Commit/Reveal): ~45s (configurable via NEXT_PUBLIC_POLL_GAME_ACTIVE)
  - Waiting phase (ZeroPhase): ~60s (configurable via NEXT_PUBLIC_POLL_GAME_WAITING)
  - Completed: Disabled by default (configurable via NEXT_PUBLIC_POLL_GAME_COMPLETED)
- **Supporting queries** (players, votes, commits, rounds): NO polling
  - Refetch when primary query invalidates cache
  - Refetch on window focus
  - After mutations via `invalidateGame(gameId)`

**Required environment variables** (app crashes if missing):
```bash
NEXT_PUBLIC_POLL_GAME_ACTIVE=45000
NEXT_PUBLIC_POLL_GAME_WAITING=60000
NEXT_PUBLIC_POLL_GAME_COMPLETED=false
NEXT_PUBLIC_POLL_GAMES_ACTIVE=45000
NEXT_PUBLIC_POLL_GAMES_COMPLETED=90000
```

### 5. Cache Invalidation After Mutations
Pattern used throughout frontend:
```typescript
// 1. Write to contract
const { writeContract } = useWriteContract();
writeContract({ address, abi, functionName: 'joinGame', args: [gameId] });

// 2. Wait for transaction
const { isSuccess } = useWaitForTransactionReceipt({ hash });

// 3. Invalidate cache on success
const { invalidateGame } = useGameMutations();
if (isSuccess) {
  await invalidateGame(gameId);  // Triggers refetch of all game data
}
```

## Indexer Details

### Event Handlers
Location: `indexer/src/index.ts`

Each contract event has a handler that:
1. Extracts event data from `event.args`
2. Converts addresses to lowercase
3. Converts BigInt to strings for storage
4. Updates database tables via `context.db.insert()` or `context.db.update()`

**Important handlers:**
- `GameCreated` - Creates game record with ZeroPhase state
- `PlayerJoined` - Adds player, updates prize pool, creates elimination record
- `CommitPhaseStarted` / `RevealPhaseStarted` - Updates deadlines and state
- `RoundCompleted` - Updates eliminations, stores round results
- `GameCompleted` - Marks game complete, stores winners

### Database Schema
Location: `indexer/ponder.schema.ts`

All tables use `onchainTable` (optimized for blockchain data):
- `games` - Game metadata (question, fee, state, deadlines, prize pool)
- `players` - Who joined which game and when
- `votes` - Revealed votes (game_id, round, player_address, vote)
- `commits` - Committed vote hashes
- `rounds` - Round results (yes/no counts, minority vote, remaining players)
- `winners` - Final prize distribution
- `eliminations` - Player elimination tracking (eliminated boolean, round)

### GraphQL API
Ponder auto-generates GraphQL API from schema:
- Single item: `game(id: "1")`
- List: `games(limit: 20, offset: 0, where: {...}, orderBy: "block_number", orderDirection: "desc")`
- Pagination: Cursor-based with `pageInfo { hasNextPage, endCursor }`
- Subscriptions: Real-time updates via WebSockets (planned, not yet implemented)

## Frontend Details

### GraphQL Integration
Location: `frontend/src/lib/graphql/`

**Client setup** (`client.ts`):
- urql with WebSocket support
- Endpoint: `http://localhost:42069/graphql` (dev) or configurable for production
- Subscriptions: `ws://localhost:42069/graphql` (ready but not yet used)

**Queries** (`queries.ts`):
- `GET_ACTIVE_GAMES` - Games in ZeroPhase/CommitPhase/RevealPhase
- `GET_COMPLETED_GAMES` - Games in Completed state
- `GET_GAME` - Single game with all details
- `GET_GAME_PLAYERS` - All players for a game
- `GET_GAME_VOTES` - Votes for game + round
- 15+ more queries covering all data access patterns

**Subscriptions** (`subscriptions.ts`):
- `GAME_UPDATED` - Real-time game state changes
- `NEW_PLAYER_JOINED` - Live player joins
- `NEW_VOTE_REVEALED` - Live vote reveals
- Not yet connected to UI (planned future enhancement)

### React Query Architecture
Location: `frontend/src/hooks/queries/`

**Query key factory** (`lib/query-keys.ts`):
- Hierarchical keys for granular cache control
- Example: `['game', gameId, 'votes', round]`
- Enables selective invalidation (invalidate all game data or just votes)

**Mutation helpers** (`hooks/mutations/use-game-mutations.ts`):
- `invalidateGame(gameId)` - Refetch all data for specific game
- `invalidateGameLists()` - Refetch active/completed game lists
- `optimisticUpdateGame()` - Update cache before server confirms

**Polling configuration** (`lib/polling-config.ts`):
- Centralized polling interval management
- Environment variable validation (crashes with helpful errors if misconfigured)
- No automatic defaults (explicit configuration required)

### Wagmi Configuration
Location: `frontend/src/lib/wagmi.ts`

Chains supported:
- Foundry (chainId: 31337, localhost:8545) - Local development
- Base Sepolia (chainId: 84532) - Testnet
- Base Mainnet (chainId: 8453) - Production

Contract addresses per chain in `lib/contracts.ts`:
```typescript
const CONTRACTS = {
  31337: process.env.NEXT_PUBLIC_CONTRACT_ADDRESS_ANVIL,
  84532: process.env.NEXT_PUBLIC_CONTRACT_ADDRESS_BASE_SEPOLIA,
  8453: process.env.NEXT_PUBLIC_CONTRACT_ADDRESS_BASE,
};
```

## Testing Patterns

### Smart Contract Testing
Location: `solidity/test/` (test files use `.t.sol` extension)

Run tests:
```bash
cd solidity
forge test -vv          # Basic verbosity
forge test -vvvv        # Max verbosity (shows traces)
forge test --match-test testJoinGame  # Run specific test
```

### Local Game Simulation
The indexer has simulation scripts for testing multi-round games:
```bash
cd indexer
npm run simulate:multi-round      # Simulates full game with multiple rounds
npm run simulate:three-rounds     # Simulates exactly 3 rounds
npm run test:transactions         # Tests transaction indexing
```

### Frontend Testing Flow
1. Connect MetaMask to localhost:8545
2. Import Anvil test accounts (private keys shown in Anvil output)
3. Create game with test account
4. Join with different accounts
5. Use inline deadline setter on settings page to control phases
6. Commit votes during CommitPhase
7. Reveal votes during RevealPhase (salt auto-saved in localStorage)
8. Process round to eliminate majority voters
9. Repeat until winner(s) determined

## Common Issues & Solutions

### "Ponder not starting on port 42069"
- Check `indexer/.env` has `DATABASE_URL` and `CONTRACT_ADDRESS_ANVIL`
- Try `npm run dev:fresh` to reset database
- See `GRAPHQL_MIGRATION_STATUS.md` for detailed troubleshooting
- Fallback: Temporarily use Supabase queries (still has pagination)

### "Transaction failed: wrong game phase"
- Games have strict phase transitions: ZeroPhase → CommitPhase → RevealPhase
- Can only join during Round 1 CommitPhase
- Can only commit votes during CommitPhase
- Can only reveal during RevealPhase after commit deadline passed

### "Cannot reveal vote: salt not found"
- Salts stored in browser localStorage: `vote-salt-${gameId}-${round}`
- Clearing localStorage loses salts (cannot reveal that round)
- Each browser/device has separate salt storage
- Use salt backup/restore feature if available

### "Wrong network" in MetaMask
- Check MetaMask is on correct network:
  - Local: localhost:8545 (chainId 31337)
  - Testnet: Base Sepolia (chainId 84532)
  - Production: Base Mainnet (chainId 8453)
- Frontend shows network mismatch if wrong chain

### "Contract address not found"
- Check environment variables set correctly:
  - Indexer: `.env` (CONTRACT_ADDRESS_ANVIL, etc.)
  - Frontend: `.env.local` (NEXT_PUBLIC_CONTRACT_ADDRESS_ANVIL, etc.)
- After redeploying contract locally, update both .env files

### "GraphQL query failing"
- Verify Ponder indexer is running: `curl http://localhost:42069/graphql`
- Check Ponder logs for indexing errors
- Verify contract events are being emitted (check Anvil logs)
- Try `npm run dev:fresh` to reset indexer database

### "WebSocket not connecting"
- Check WebSocket server is running: `curl http://localhost:3001/health`
- Verify `NEXT_PUBLIC_WEBSOCKET_URL` in frontend `.env.local` is set to `ws://localhost:3001`
- Check browser console for WebSocket connection errors
- WebSocket is optional - frontend will fall back to polling if not available

### "Real-time updates not working"
- Verify WebSocket server is running on port 3001
- Check browser DevTools → Network → WS tab for connection status
- Verify Ponder is sending notifications (check WebSocket server logs)
- Check for firewall blocking WebSocket connections
- Fallback: Updates will still work via polling (slower, but reliable)

## Important Files Reference

**Smart Contract:**
- `solidity/src/MinorityRuleGame.sol` - Core game logic, commit-reveal, prize distribution
- `solidity/script/Deploy.s.sol` - Deployment script
- `solidity/foundry.toml` - Foundry configuration

**Indexer:**
- `indexer/src/index.ts` - Event handlers for all contract events (with WebSocket notifications)
- `indexer/src/utils/websocket-notifier.ts` - Fire-and-forget HTTP client for WebSocket server
- `indexer/ponder.schema.ts` - Database schema (games, players, votes, etc.)
- `indexer/ponder.config.ts` - Network and contract configuration
- `indexer/scripts/reset-ponder.sh` - Database reset script

**WebSocket Server:**
- `websocket/src/server.ts` - Main server orchestrator (HTTP + WebSocket)
- `websocket/src/http-api.ts` - Express HTTP endpoint for Ponder notifications
- `websocket/src/websocket-handler.ts` - WebSocket connection and message handling
- `websocket/src/room-manager.ts` - Room subscriptions and event broadcasting
- `websocket/src/types.ts` - Shared TypeScript types
- `websocket/README.md` - Detailed WebSocket server documentation

**Frontend Core:**
- `frontend/src/lib/wagmi.ts` - Blockchain client setup
- `frontend/src/lib/contracts.ts` - Contract ABI and addresses
- `frontend/src/lib/query-keys.ts` - React Query cache key factory
- `frontend/src/lib/polling-config.ts` - Centralized polling configuration
- `frontend/src/hooks/mutations/use-game-mutations.ts` - Cache invalidation helpers

**Frontend GraphQL:**
- `frontend/src/lib/graphql/client.ts` - urql GraphQL client
- `frontend/src/lib/graphql/queries.ts` - All GraphQL queries
- `frontend/src/lib/graphql/subscriptions.ts` - Real-time subscriptions (planned)
- `frontend/codegen.yml` - GraphQL code generation config

**Frontend WebSocket:**
- `frontend/src/lib/websocket/client.ts` - WebSocket client with auto-reconnection
- `frontend/src/lib/websocket/types.ts` - Message type definitions
- `frontend/src/lib/websocket/config.ts` - WebSocket configuration
- `frontend/src/hooks/websocket/use-websocket-game.ts` - Game-specific real-time updates
- `frontend/src/hooks/websocket/use-websocket-connection.ts` - Connection status monitoring
- `frontend/src/components/websocket-status.tsx` - Connection indicator component (optional)

**Frontend Data Hooks:**
- `frontend/src/hooks/queries/use-game.ts` - Primary game query with adaptive polling
- `frontend/src/hooks/queries/use-games.ts` - Active/completed game lists (uses GraphQL)
- `frontend/src/hooks/queries/use-game-players.ts` - Game participants
- `frontend/src/hooks/queries/use-game-votes.ts` - Vote history by round
- `frontend/src/hooks/queries/use-game-rounds.ts` - Round results

**Documentation:**
- `QUICK_START_GUIDE.md` - Getting started with current GraphQL setup
- `GRAPHQL_MIGRATION_STATUS.md` - Migration progress and troubleshooting
- `IMPLEMENTATION_SUMMARY.md` - Detailed implementation notes
- `websocket/README.md` - WebSocket server documentation and testing guide
- `frontend/CLAUDE.md` - Frontend-specific developer guide (comprehensive)
- `solidity/README.md` - Contract usage examples and deployment

## Environment Variables

### Indexer (indexer/.env)
```bash
DATABASE_URL=postgresql://...           # Postgres connection string
CONTRACT_ADDRESS_ANVIL=0x5FbDB2315...  # Local deployment address
START_BLOCK_ANVIL=0                     # Block to start indexing from
WEBSOCKET_API_URL=http://localhost:3001/api/notify  # WebSocket server endpoint (optional)
# DISABLE_WEBSOCKET=true                # Set to disable WebSocket notifications
# Uncomment for testnet:
# CONTRACT_ADDRESS_BASE_SEPOLIA=0x...
# START_BLOCK_BASE_SEPOLIA=12345
```

### WebSocket Server (websocket/.env)
```bash
PORT=3001                               # Server port
NODE_ENV=development                    # Environment
LOG_LEVEL=info                          # Logging level (debug, info, warn, error)
SHARED_SECRET=optional-token            # Optional auth token (future)
```

### Frontend (frontend/.env.local)
```bash
# Supabase (legacy, may be removed after full GraphQL migration)
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...

# Contract addresses
NEXT_PUBLIC_CONTRACT_ADDRESS_ANVIL=0x5FbDB2315...
NEXT_PUBLIC_CONTRACT_ADDRESS_BASE_SEPOLIA=0x...
NEXT_PUBLIC_CONTRACT_ADDRESS_BASE=0x...

# Required polling intervals (milliseconds or "false")
NEXT_PUBLIC_POLL_GAME_ACTIVE=45000       # Active game phases
NEXT_PUBLIC_POLL_GAME_WAITING=60000      # Waiting phase
NEXT_PUBLIC_POLL_GAME_COMPLETED=false    # Completed games (recommend: false)
NEXT_PUBLIC_POLL_GAMES_ACTIVE=45000      # Active games list
NEXT_PUBLIC_POLL_GAMES_COMPLETED=90000   # Completed games list

# WebSocket server URL (for real-time updates)
NEXT_PUBLIC_WEBSOCKET_URL=ws://localhost:3001  # Optional, falls back to polling if not set
```

### Solidity (solidity/.env)
```bash
PRIVATE_KEY=0x...                       # Deployer private key
PLATFORM_RECIPIENT=0x...                # Platform fee recipient (optional)
BASE_SEPOLIA_RPC_URL=https://...       # Base Sepolia RPC
BASESCAN_API_KEY=...                   # For contract verification
```

## Development Notes

### When Adding New Contract Events
1. Update contract and emit new event
2. Rebuild: `cd solidity && forge build`
3. Extract ABI: `cd ../indexer && npm run extract-abi`
4. Add handler in `indexer/src/index.ts`
   - Add DB operations
   - Call `notifyWebSocket(eventType, gameId, data)` after DB operations
5. Update schema in `indexer/ponder.schema.ts` if new tables needed
6. Reset indexer: `npm run dev:fresh`
7. Add event type to `websocket/src/types.ts` (GameEventType union)
8. Add GraphQL query in `frontend/src/lib/graphql/queries.ts`
9. Create React Query hook in `frontend/src/hooks/queries/`
10. Add event handler in `frontend/src/hooks/websocket/use-websocket-game.ts` (optional)

### When Deploying to New Network
1. Deploy contract: `forge script script/Deploy.s.sol --rpc-url <network> --broadcast`
2. Update `indexer/ponder.config.ts` with network config
3. Update `indexer/.env` with contract address and start block
4. Update `frontend/src/lib/wagmi.ts` to include new chain
5. Update `frontend/src/lib/contracts.ts` with contract address
6. Set `NEXT_PUBLIC_CONTRACT_ADDRESS_<NETWORK>` in frontend `.env.local`

### Performance Considerations
- Polling intervals tuned for bandwidth efficiency (45-90s recommended for production)
- No independent polling for supporting queries (rely on cache invalidation)
- Pagination limits set at 20 items per page for game lists
- Ponder indexer caches blockchain data (faster than direct RPC queries)
- React Query caches data aggressively (5-minute stale time for most queries)
